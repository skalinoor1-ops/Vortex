<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Vortex</title>
<meta name="description" content="A Gemini-style AI interface with streaming, history, and multimodal support.">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Google+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<style>
/* --- VARIABLES --- */
:root {
    --bg-body: #ffffff;
    --bg-sidebar: #f0f4f9;
    --bg-surface: #f0f4f9;
    --bg-surface-hover: #dfe4ea;
    --bg-modal: rgba(255, 255, 255, 0.95);
    --text-main: #1f1f1f;
    --text-sub: #444746;
    --border: #e0e0e0;
    
    --accent: #0b57d0;
    --accent-hover: #0842a0;
    --user-bubble: #f0f4f9;
    
    --gemini-grad: linear-gradient(135deg, #4b90ff 0%, #ff5546 100%);
    --gemini-text: linear-gradient(90deg, #4b90ff, #ff5546);
    
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
    
    --bezier: cubic-bezier(0.4, 0, 0.2, 1);
}

/* --- RESET & BASE --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body {
    margin: 0; font-family: 'Google Sans', 'Outfit', sans-serif;
    background: var(--bg-body); color: var(--text-main);
    height: 100vh; height: 100dvh; display: flex; overflow: hidden;
    transition: background 0.3s, color 0.3s;
}

/* --- ANIMATIONS --- */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

/* --- SIDEBAR --- */
.sidebar {
    width: 280px; background: var(--bg-sidebar); display: flex; flex-direction: column;
    padding: 20px 12px; height: 100%; position: relative; z-index: 50;
    transition: transform 0.3s var(--bezier);
}
.sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 0 8px; }
.sidebar-toggle { border: none; background: transparent; cursor: pointer; color: var(--text-sub); padding: 8px; border-radius: 50%; }
.sidebar-toggle:hover { background: rgba(0,0,0,0.05); }

.new-chat-btn {
    background: #dfe4ea; color: var(--text-main); border: none; padding: 12px 20px;
    border-radius: 24px; font-family: inherit; font-size: 14px; font-weight: 500;
    display: flex; align-items: center; gap: 10px; cursor: pointer;
    transition: 0.2s; margin-bottom: 20px; box-shadow: var(--shadow-sm);
}
.new-chat-btn:hover { background: #d1d9e0; box-shadow: var(--shadow-md); }

.history-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; padding-bottom: 20px; }
.history-group-title { font-size: 11px; font-weight: 600; color: #888; margin: 15px 12px 5px; text-transform: uppercase; letter-spacing: 0.5px; }

.chat-item {
    padding: 10px 16px; border-radius: 20px; cursor: pointer;
    font-size: 14px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    display: flex; align-items: center; gap: 10px; transition: 0.2s;
    position: relative;
}
.chat-item:hover { background: rgba(0,0,0,0.05); }
.chat-item.active { background: #d3e3fd; font-weight: 500; }
.chat-item .delete-chat {
    position: absolute; right: 8px; opacity: 0; transition: 0.2s;
    background: inherit; border: none; color: #666; cursor: pointer;
}
.chat-item:hover .delete-chat { opacity: 1; }

.user-profile {
    margin-top: auto; padding: 12px; border-radius: 12px;
    display: flex; align-items: center; gap: 10px; cursor: pointer;
    transition: 0.2s; font-size: 14px; font-weight: 500;
}
.user-profile:hover { background: rgba(0,0,0,0.05); }
.avatar-small { width: 32px; height: 32px; background: #0b57d0; color: #fff; border-radius: 50%; display: grid; place-items: center; font-size: 14px; }

/* --- MAIN CONTENT --- */
.main-area { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-body); }

/* Header */
.top-bar {
    height: 60px; display: flex; align-items: center; padding: 0 20px;
    justify-content: space-between; position: sticky; top: 0; z-index: 10;
}
.mobile-menu-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text-main); cursor: pointer; }
.model-selector {
    display: flex; align-items: center; gap: 6px; font-size: 16px; font-weight: 500;
    color: var(--text-sub); cursor: pointer; padding: 6px 12px; border-radius: 8px;
}
.model-selector:hover { background: var(--bg-surface); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: #27c93f; margin-left: 5px; }
.status-dot.offline { background: #d93025; }

/* Chat Container */
.chat-scroll-area {
    flex: 1; overflow-y: auto; padding: 20px 0 140px;
    display: flex; flex-direction: column; align-items: center;
    scroll-behavior: smooth;
}
.chat-content { width: 100%; max-width: 800px; padding: 0 20px; display: flex; flex-direction: column; gap: 24px; }

/* Welcome Screen */
.welcome-screen {
    margin-top: 10vh; opacity: 1; transition: opacity 0.5s;
    display: flex; flex-direction: column; gap: 40px;
}
.hero-text {
    font-size: 56px; line-height: 1.1; font-weight: 600; letter-spacing: -1px;
    background: var(--gemini-text); -webkit-background-clip: text; color: transparent;
}
.hero-text span { color: #c4c7c5; background: none; -webkit-text-fill-color: #c4c7c5; }
.suggestions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
.suggestion-card {
    background: var(--bg-surface); padding: 16px; border-radius: 12px; cursor: pointer;
    height: 180px; display: flex; flex-direction: column; justify-content: space-between;
    transition: 0.2s; border: 1px solid transparent;
}
.suggestion-card:hover { background: var(--bg-surface-hover); border-color: #ccc; }
.suggestion-card p { margin: 0; font-size: 15px; color: var(--text-main); }
.card-icon { align-self: flex-end; width: 36px; height: 36px; background: #fff; border-radius: 50%; display: grid; place-items: center; box-shadow: var(--shadow-sm); }

/* Messages */
.msg-row { display: flex; gap: 16px; width: 100%; animation: fadeIn 0.4s ease; position: relative; }
.msg-row.user { flex-direction: row-reverse; }
.msg-avatar {
    width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; display: grid; place-items: center; font-size: 14px; font-weight: 600;
}
.msg-avatar.ai { background: var(--gemini-grad); color: white; }
.msg-avatar.user { background: var(--accent); color: white; }

.msg-bubble {
    max-width: 85%; line-height: 1.6; font-size: 16px; color: var(--text-main);
    overflow-x: hidden;
}
.msg-row.user .msg-bubble {
    background: var(--user-bubble); padding: 12px 20px; border-radius: 18px 4px 18px 18px;
}
.msg-row.ai .msg-bubble { padding-top: 4px; }

/* Markdown Styles */
.prose p { margin-bottom: 1em; margin-top: 0; }
.prose ul, .prose ol { margin: 0 0 1em 20px; padding: 0; }
.prose li { margin-bottom: 0.5em; }
.prose strong { font-weight: 600; color: #000; }
.prose h1, .prose h2, .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 600; }
.prose a { color: var(--accent); text-decoration: none; }
.prose a:hover { text-decoration: underline; }
.prose table { border-collapse: collapse; width: 100%; margin: 1em 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
.prose th, .prose td { padding: 8px 12px; border: 1px solid #ddd; text-align: left; }
.prose th { background: #f8f9fa; font-weight: 600; }

/* Code Blocks */
.code-block-wrapper {
    margin: 16px 0; border-radius: 8px; overflow: hidden; border: 1px solid #444;
    background: #1e1f20; font-family: 'JetBrains Mono', monospace;
}
.code-header {
    background: #2b2d30; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center;
    color: #aeb2b5; font-size: 12px; user-select: none;
}
.copy-btn { background: transparent; border: none; color: inherit; cursor: pointer; display: flex; align-items: center; gap: 4px; }
.copy-btn:hover { color: #fff; }
.prose pre { margin: 0; padding: 12px; overflow-x: auto; background: transparent; }
.prose code { font-family: 'JetBrains Mono', monospace; font-size: 13px; }

/* Message Actions */
.msg-actions {
    display: flex; gap: 8px; margin-top: 8px; opacity: 0; transition: 0.2s;
}
.msg-row:hover .msg-actions { opacity: 1; }
.action-icon {
    cursor: pointer; padding: 4px; color: var(--text-sub); border-radius: 4px;
}
.action-icon:hover { background: #f0f4f9; color: var(--text-main); }

/* --- INPUT AREA --- */
.input-wrapper {
    position: fixed; bottom: 0; left: 280px; right: 0;
    background: var(--bg-body); padding: 20px;
    display: flex; justify-content: center; z-index: 20;
    transition: left 0.3s var(--bezier);
}
.input-container {
    width: 100%; max-width: 800px; position: relative;
    background: var(--bg-sidebar); border-radius: 28px;
    border: 1px solid transparent; transition: 0.2s;
    display: flex; flex-direction: column;
}
.input-container:focus-within { background: #fff; box-shadow: 0 0 0 1px #ccc, 0 2px 6px rgba(0,0,0,0.05); }

.preview-area { display: flex; gap: 10px; padding: 10px 16px 0; display: none; }
.img-preview { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; }

.input-box {
    display: flex; align-items: flex-end; padding: 10px 16px; gap: 10px;
}
.attach-btn {
    padding: 8px; border-radius: 50%; border: none; background: transparent; cursor: pointer; color: var(--text-main);
    transition: 0.2s;
}
.attach-btn:hover { background: #e1e5ea; }

textarea {
    flex: 1; background: transparent; border: none; resize: none;
    font-family: inherit; font-size: 16px; line-height: 24px;
    max-height: 150px; padding: 8px 0;
}

.send-btn {
    width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent;
    display: grid; place-items: center; cursor: pointer; color: var(--text-main);
    transition: 0.2s;
}
.send-btn.active { background: var(--accent); color: white; }
.send-btn:disabled { opacity: 0.5; cursor: default; }

.disclaimer { font-size: 12px; color: #666; text-align: center; margin-top: 8px; }

/* --- MODALS --- */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
    display: flex; justify-content: center; align-items: center;
    opacity: 0; visibility: hidden; transition: 0.3s;
}
.modal-overlay.open { opacity: 1; visibility: visible; }
.modal {
    background: var(--bg-body); width: 90%; max-width: 500px;
    border-radius: 24px; padding: 24px;
    transform: scale(0.95); transition: 0.3s var(--bezier);
}
.modal-overlay.open .modal { transform: scale(1); }
.modal h2 { margin: 0 0 20px; font-size: 22px; }

.setting-item { margin-bottom: 20px; }
.setting-item label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
.setting-input {
    width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc;
    font-family: inherit; font-size: 14px;
}
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
.btn { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; font-weight: 500; }
.btn-ghost { background: transparent; color: var(--accent); }
.btn-primary { background: var(--accent); color: white; }

/* --- TOAST --- */
.toast-container {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;
}
.toast {
    background: #323232; color: #fff; padding: 12px 24px; border-radius: 8px;
    font-size: 14px; box-shadow: var(--shadow-md); opacity: 0;
    transform: translateY(20px); transition: 0.3s; pointer-events: auto;
}
.toast.visible { opacity: 1; transform: translateY(0); }

/* --- RESPONSIVE --- */
@media (max-width: 768px) {
    .sidebar { position: fixed; transform: translateX(-100%); width: 80%; max-width: 300px; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
    .sidebar.open { transform: translateX(0); }
    .mobile-menu-btn { display: block; }
    .input-wrapper { left: 0; }
    .hero-text { font-size: 40px; }
}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <button class="sidebar-toggle mobile-only" onclick="toggleSidebar()">
            <span class="material-icons-round">menu_open</span>
        </button>
        <div style="font-weight:700; font-size:18px; color:var(--text-sub);">Vortex</div>
    </div>
    
    <button class="new-chat-btn" onclick="app.newChat()">
        <span class="material-icons-round">add</span> New Chat
    </button>
    
    <div class="history-list" id="historyList">
        <div class="history-group-title">Recent</div>
        </div>
    
    <div class="user-profile" onclick="ui.openSettings()">
        <div class="avatar-small">You</div>
        <div style="flex:1;">Settings</div>
        <span class="material-icons-round" style="font-size:18px;">settings</span>
    </div>
</aside>

<div class="modal-overlay" id="sidebarOverlay" onclick="toggleSidebar()" style="z-index:40;"></div>

<main class="main-area">
    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <span class="material-icons-round">menu</span>
            </button>
            <div class="model-selector" onclick="ui.openSettings()">
                <span id="currentModelDisplay">V 1.0</span>
                <span class="material-icons-round" style="font-size:16px;">arrow_drop_down</span>
                <div class="status-dot" id="connStatus"></div>
            </div>
        </div>
        <div class="avatar-small" style="background:var(--gemini-grad);">V</div>
    </div>

    <div class="chat-scroll-area" id="scrollArea">
        <div class="welcome-screen" id="welcomeScreen">
            <div class="hero-text">
                <span>Hello, User</span><br>How can I help today?
            </div>
            <div class="suggestions-grid">
                <div class="suggestion-card" onclick="app.suggestion('Explain quantum computing in simple terms')">
                    <p>Explain quantum computing in simple terms</p>
                    <div class="card-icon"><span class="material-icons-round">science</span></div>
                </div>
                <div class="suggestion-card" onclick="app.suggestion('Write a Python script to scrape a website')">
                    <p>Write a Python script to scrape a website</p>
                    <div class="card-icon"><span class="material-icons-round">code</span></div>
                </div>
                <div class="suggestion-card" onclick="app.suggestion('Create a study plan for learning Spanish')">
                    <p>Create a study plan for learning Spanish</p>
                    <div class="card-icon"><span class="material-icons-round">school</span></div>
                </div>
                <div class="suggestion-card" onclick="app.suggestion('Draft a professional email to my boss')">
                    <p>Draft a professional email</p>
                    <div class="card-icon"><span class="material-icons-round">mail</span></div>
                </div>
            </div>
        </div>

        <div class="chat-content" id="chatContent"></div>
    </div>

    <div class="input-wrapper">
        <div class="input-container">
            <div class="preview-area" id="imagePreviewArea"></div>
            
            <div class="input-box">
                <button class="attach-btn" onclick="document.getElementById('fileInput').click()">
                    <span class="material-icons-round">add_photo_alternate</span>
                </button>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="app.handleImageUpload(this)">
                
                <textarea id="userInput" rows="1" placeholder="Enter a prompt here" oninput="ui.autoResize(this)" onkeydown="app.handleEnter(event)"></textarea>
                
                <button class="attach-btn" id="voiceBtn" onclick="voice.toggle()">
                    <span class="material-icons-round">mic</span>
                </button>
                
                <button class="send-btn" id="sendBtn" onclick="app.send()">
                    <span class="material-icons-round">send</span>
                </button>
            </div>
        </div>
        <div style="position:absolute; bottom:5px; font-size:11px; color:#aaa;">Vortex May give false answer, recheck it</div>
    </div>
</main>

<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <h2>Settings</h2>
        <div class="setting-item">
            <label>API Key (OpenRouter)</label>
            <input type="password" class="setting-input" id="apiKeyInput" placeholder="sk-or-v1-...">
        </div>
        <div class="setting-item">
            <label>System Prompt</label>
            <textarea class="setting-input" id="sysPromptInput" rows="3" placeholder="You are Vortex..."></textarea>
        </div>
        <div class="setting-item">
            <label>Temperature (Creativity)</label>
            <input type="range" id="tempInput" min="0" max="1" step="0.1" style="width:100%">
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="ui.closeSettings()">Cancel</button>
            <button class="btn btn-primary" onclick="app.saveSettings()">Save</button>
        </div>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn btn-ghost" style="color:#d93025; width:100%; text-align:left;" onclick="app.clearAllData()">Delete All Chat History</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
/**
 * VORTEX ULTIMATE ENGINE
 * Architecture:
 * 1. Store: Manages LocalStorage (Chats, Settings).
 * 2. UI: DOM manipulation, rendering Markdown, auto-scroll.
 * 3. App: Logic, API calls, event handling.
 * 4. Voice: Speech recognition logic.
 */

// --- 1. STORE ---
const Store = {
    getSettings: () => {
        const defaultSettings = {
            apiKey: "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", // Provided by user
            model: "meta-llama/llama-3.2-3b-instruct:free",
            systemPrompt: "You are Vortex, a helpful and capable AI assistant created by Sk Asif Nur Islam. Use Markdown for formatting. Use LaTeX for math.",
            temperature: 0.7
        };
        const saved = JSON.parse(localStorage.getItem('vortex_settings') || '{}');
        return { ...defaultSettings, ...saved };
    },
    saveSettings: (settings) => {
        localStorage.setItem('vortex_settings', JSON.stringify(settings));
    },
    getChats: () => {
        return JSON.parse(localStorage.getItem('vortex_chats') || '[]');
    },
    saveChats: (chats) => {
        localStorage.setItem('vortex_chats', JSON.stringify(chats));
    },
    addChat: (chat) => {
        const chats = Store.getChats();
        chats.unshift(chat);
        Store.saveChats(chats);
        return chats;
    },
    updateChat: (id, messages) => {
        const chats = Store.getChats();
        const chat = chats.find(c => c.id === id);
        if(chat) {
            chat.messages = messages;
            // Generate title from first message if new
            if(chat.title === 'New Chat' && messages.length > 0) {
                const firstUser = messages.find(m => m.role === 'user');
                if(firstUser) chat.title = firstUser.content.substring(0, 30) + '...';
            }
            Store.saveChats(chats);
        }
    },
    deleteChat: (id) => {
        const chats = Store.getChats().filter(c => c.id !== id);
        Store.saveChats(chats);
        return chats;
    }
};

// --- 2. UI RENDERER ---
const UI = {
    mdRenderer: new marked.Renderer(),
    
    init: () => {
        // Configure Marked
        UI.mdRenderer.code = (code, language) => {
            const validLang = hljs.getLanguage(language) ? language : 'plaintext';
            const highlighted = hljs.highlight(code, { language: validLang }).value;
            return `
            <div class="code-block-wrapper">
                <div class="code-header">
                    <span>${validLang}</span>
                    <button class="copy-btn" onclick="UI.copyToClipboard(this)">
                        <span class="material-icons-round" style="font-size:14px">content_copy</span> Copy
                    </button>
                </div>
                <pre><code class="hljs ${validLang}">${highlighted}</code></pre>
            </div>`;
        };
        marked.setOptions({ renderer: UI.mdRenderer });
        
        // Settings Inputs Init
        const s = Store.getSettings();
        document.getElementById('apiKeyInput').value = s.apiKey;
        document.getElementById('sysPromptInput').value = s.systemPrompt;
        document.getElementById('tempInput').value = s.temperature;
    },

    renderMessage: (role, content, isThinking=false) => {
        const div = document.createElement('div');
        div.className = `msg-row ${role}`;
        
        let innerHTML = '';
        if(isThinking) {
            innerHTML = `<span class="material-icons-round" style="animation:spin 1s infinite">refresh</span>`;
        } else if (role === 'ai') {
            // Parse Markdown first
            let html = marked.parse(content);
            // Then Render Math (Simple replacement logic for demo, complex needs regex)
            div.innerHTML = `
                <div class="msg-avatar ai">V</div>
                <div class="msg-bubble prose">${html}</div>
                <div class="msg-actions">
                    <span class="material-icons-round action-icon" onclick="UI.copyText(this)">content_copy</span>
                    <span class="material-icons-round action-icon" onclick="app.regenerate()">refresh</span>
                </div>
            `;
            // Render Math
            renderMathInElement(div.querySelector('.prose'), {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });
            return div;
        } else {
            // User message (escape HTML)
            div.innerHTML = `
                <div class="msg-avatar user">U</div>
                <div class="msg-bubble">${content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                <div class="msg-actions">
                    <span class="material-icons-round action-icon" onclick="app.editMessage(this)">edit</span>
                </div>
            `;
            return div;
        }
        
        div.innerHTML = `
            <div class="msg-avatar ${role}">${role === 'ai' ? 'V' : 'U'}</div>
            <div class="msg-bubble">${innerHTML}</div>
        `;
        return div;
    },

    renderHistory: () => {
        const list = document.getElementById('historyList');
        const chats = Store.getChats();
        
        // Keep the "Recent" title
        list.innerHTML = '<div class="history-group-title">Recent</div>';
        
        chats.forEach(chat => {
            const item = document.createElement('div');
            item.className = `chat-item ${app.currentChatId === chat.id ? 'active' : ''}`;
            item.innerHTML = `
                <span class="material-icons-round" style="font-size:16px;">chat_bubble_outline</span>
                <span style="flex:1; overflow:hidden; text-overflow:ellipsis;">${chat.title}</span>
                <button class="delete-chat" onclick="event.stopPropagation(); app.deleteChat('${chat.id}')">
                    <span class="material-icons-round" style="font-size:16px;">delete</span>
                </button>
            `;
            item.onclick = () => app.loadChat(chat.id);
            list.appendChild(item);
        });
    },

    showToast: (msg) => {
        const container = document.getElementById('toastContainer');
        const el = document.createElement('div');
        el.className = 'toast';
        el.innerText = msg;
        container.appendChild(el);
        setTimeout(() => el.classList.add('visible'), 10);
        setTimeout(() => {
            el.classList.remove('visible');
            setTimeout(() => el.remove(), 300);
        }, 3000);
    },

    autoResize: (el) => {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 150) + 'px';
        const btn = document.getElementById('sendBtn');
        if(el.value.trim()) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    },

    scrollToBottom: () => {
        const area = document.getElementById('scrollArea');
        area.scrollTop = area.scrollHeight;
    },

    openSettings: () => {
        document.getElementById('settingsModal').classList.add('open');
        document.getElementById('sidebarOverlay').classList.add('open');
    },
    closeSettings: () => {
        document.getElementById('settingsModal').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('open');
    },
    
    copyToClipboard: (btn) => {
        const code = btn.closest('.code-block-wrapper').querySelector('code').innerText;
        navigator.clipboard.writeText(code);
        UI.showToast("Code copied!");
    },
    copyText: (btn) => {
        const text = btn.closest('.msg-row').querySelector('.msg-bubble').innerText;
        navigator.clipboard.writeText(text);
        UI.showToast("Response copied!");
    }
};

// --- 3. APP LOGIC ---
const app = {
    currentChatId: null,
    messages: [],
    imageBase64: null,

    init: () => {
        UI.init();
        const chats = Store.getChats();
        if(chats.length > 0) {
            app.loadChat(chats[0].id); // Load most recent
        } else {
            app.newChat();
        }
        UI.renderHistory();
        
        // Connectivity check
        window.addEventListener('online', () => document.getElementById('connStatus').classList.remove('offline'));
        window.addEventListener('offline', () => document.getElementById('connStatus').classList.add('offline'));
    },

    newChat: () => {
        const id = Date.now().toString();
        const newChat = { id, title: 'New Chat', messages: [], timestamp: Date.now() };
        Store.addChat(newChat);
        app.loadChat(id);
    },

    loadChat: (id) => {
        app.currentChatId = id;
        const chat = Store.getChats().find(c => c.id === id);
        if(!chat) return;
        
        app.messages = chat.messages || [];
        
        // UI Reset
        const container = document.getElementById('chatContent');
        container.innerHTML = '';
        document.getElementById('welcomeScreen').style.display = app.messages.length === 0 ? 'flex' : 'none';
        
        // Render existing messages
        app.messages.forEach(msg => {
            container.appendChild(UI.renderMessage(msg.role, msg.content));
        });
        
        UI.renderHistory();
        if(document.body.clientWidth < 768) toggleSidebar(false); // Close sidebar on mobile load
    },

    deleteChat: (id) => {
        if(confirm("Delete this chat?")) {
            Store.deleteChat(id);
            if(app.currentChatId === id) app.newChat();
            else UI.renderHistory();
        }
    },
    
    clearAllData: () => {
        if(confirm("Are you sure? This will delete ALL history and settings.")) {
            localStorage.removeItem('vortex_chats');
            localStorage.removeItem('vortex_settings');
            location.reload();
        }
    },

    handleImageUpload: (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            app.imageBase64 = e.target.result;
            const preview = document.getElementById('imagePreviewArea');
            preview.style.display = 'flex';
            preview.innerHTML = `<img src="${app.imageBase64}" class="img-preview"><button onclick="app.clearImage()" style="border:none;background:none;cursor:pointer;">&times;</button>`;
        };
        reader.readAsDataURL(file);
    },
    
    clearImage: () => {
        app.imageBase64 = null;
        document.getElementById('imagePreviewArea').style.display = 'none';
        document.getElementById('fileInput').value = '';
    },

    suggestion: (text) => {
        document.getElementById('userInput').value = text;
        UI.autoResize(document.getElementById('userInput'));
        app.send();
    },
    
    handleEnter: (e) => {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            app.send();
        }
    },

    saveSettings: () => {
        const key = document.getElementById('apiKeyInput').value;
        const sys = document.getElementById('sysPromptInput').value;
        const temp = parseFloat(document.getElementById('tempInput').value);
        
        Store.saveSettings({
            apiKey: key,
            systemPrompt: sys,
            temperature: temp
        });
        UI.closeSettings();
        UI.showToast("Settings Saved");
    },

    send: async () => {
        const inputEl = document.getElementById('userInput');
        const text = inputEl.value.trim();
        if(!text && !app.imageBase64) return;

        // 1. Add User Message
        const userMsg = { role: 'user', content: text };
        app.messages.push(userMsg);
        document.getElementById('chatContent').appendChild(UI.renderMessage('user', text));
        document.getElementById('welcomeScreen').style.display = 'none';
        
        // Clear input
        inputEl.value = '';
        UI.autoResize(inputEl);
        UI.scrollToBottom();

        // 2. Prepare API Request
        const settings = Store.getSettings();
        const payloadMessages = [
            { role: "system", content: settings.systemPrompt },
            ...app.messages
        ];
        
        // If image exists (Note: Basic LLM text inject for now as 3.2-3b is text mostly, but structure supports Vision if model changed)
        if(app.imageBase64) {
             // For a real Vision model, you'd add content: [{type: "text", text}, {type: "image_url", ...}]
             // Here we just append a note for context since we are using a free text model
             payloadMessages[payloadMessages.length-1].content += ` [Image Attached: User uploaded an image, but I can currently only process text descriptions of it if provided.]`;
             app.clearImage();
        }

        // 3. Create Placeholder for AI Response
        const aiRow = UI.renderMessage('ai', 'Thinking...', true);
        document.getElementById('chatContent').appendChild(aiRow);
        
        // 4. Fetch with Streaming
        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${settings.apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: settings.model,
                    messages: payloadMessages,
                    stream: true, // Enable Streaming
                    temperature: settings.temperature
                })
            });

            if(!response.ok) throw new Error("API Error");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let aiText = "";
            let aiBubble = aiRow.querySelector('.msg-bubble');
            
            // Remove spinner
            aiBubble.innerHTML = ""; 

            while(true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, {stream: true});
                const lines = chunk.split('\n');
                
                for(const line of lines) {
                    if(line.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            if(json.choices && json.choices[0].delta.content) {
                                const token = json.choices[0].delta.content;
                                aiText += token;
                                // Live Render (Optimized: render MD every X chars or at end could be better, but this is immediate)
                                aiBubble.innerHTML = marked.parse(aiText); 
                                UI.scrollToBottom();
                            }
                        } catch(e) {}
                    }
                }
            }

            // Final Render with Math & Code
            const finalDiv = UI.renderMessage('ai', aiText);
            aiRow.replaceWith(finalDiv);
            
            // Save to History
            app.messages.push({ role: 'assistant', content: aiText });
            Store.updateChat(app.currentChatId, app.messages);
            UI.renderHistory();

        } catch (error) {
            aiRow.innerHTML = `<div class="msg-bubble" style="color:#d93025">Error: ${error.message}</div>`;
        }
    },
    
    regenerate: () => {
        // Remove last AI message if exists
        const lastMsg = app.messages[app.messages.length - 1];
        if(lastMsg.role === 'assistant') {
            app.messages.pop();
            document.getElementById('chatContent').lastElementChild.remove();
            app.send(); // Resend the context
        }
    }
};

// --- 4. VOICE LOGIC ---
const voice = {
    recognition: null,
    isListening: false,
    
    init: () => {
        if('webkitSpeechRecognition' in window) {
            voice.recognition = new webkitSpeechRecognition();
            voice.recognition.continuous = false;
            voice.recognition.interimResults = false;
            
            voice.recognition.onstart = () => {
                voice.isListening = true;
                document.getElementById('voiceBtn').style.color = '#d93025';
                UI.showToast("Listening...");
            };
            
            voice.recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                UI.autoResize(document.getElementById('userInput'));
                app.send();
            };
            
            voice.recognition.onend = () => {
                voice.isListening = false;
                document.getElementById('voiceBtn').style.color = 'var(--text-main)';
            };
        }
    },
    
    toggle: () => {
        if(!voice.recognition) {
            voice.init();
            if(!voice.recognition) { alert("Voice not supported in this browser"); return; }
        }
        
        if(voice.isListening) voice.recognition.stop();
        else voice.recognition.start();
    }
};

// Sidebar Logic
function toggleSidebar(force) {
    const sb = document.getElementById('sidebar');
    const ov = document.getElementById('sidebarOverlay');
    const isOpen = sb.classList.contains('open');
    const shouldOpen = force !== undefined ? force : !isOpen;
    
    if(shouldOpen) {
        sb.classList.add('open');
        ov.classList.add('open');
    } else {
        sb.classList.remove('open');
        ov.classList.remove('open');
    }
}

// INITIALIZE
window.addEventListener('DOMContentLoaded', app.init);

</script>
</body>
</html>
